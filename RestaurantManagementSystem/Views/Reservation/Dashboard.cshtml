@{
    ViewData["Title"] = "Reservation Management Dashboard";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Reservation Management Dashboard</h2>
        </div>
        <div class="col-md-6 text-md-end">
            <a asp-action="Create" class="btn btn-primary">New Reservation</a>
            <a asp-action="AddToWaitlist" class="btn btn-secondary">Add to Waitlist</a>
            <a asp-action="Tables" class="btn btn-info">Manage Tables</a>
        </div>
    </div>

    @if (TempData["ResultMessage"] != null)
    {
        <div class="alert alert-info">@TempData["ResultMessage"]</div>
    }
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Tables</h5>
                    <p class="card-text display-4">@ViewBag.TotalTables</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">Available Tables</h5>
                    <p class="card-text display-4">@ViewBag.AvailableTables</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">Occupied Tables</h5>
                    <p class="card-text display-4">@ViewBag.OccupiedTables</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark mb-3">
                <div class="card-body">
                    <h5 class="card-title">Waitlist Count</h5>
                    <p class="card-text display-4">@ViewBag.WaitlistCount</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Today's Reservations -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between">
                    <h5 class="mb-0">Today's Reservations</h5>
                    <span class="badge bg-light text-dark">@ViewBag.TodaysReservationCount</span>
                </div>
                <div class="card-body overflow-auto" style="max-height: 400px;">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Guest</th>
                                <th>Party</th>
                                <th>Table</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var res in ViewBag.TodaysReservations)
                            {
                                <tr class="@(res.Status == ReservationStatus.Seated ? "table-success" : (res.Status == ReservationStatus.Cancelled || res.Status == ReservationStatus.NoShow ? "table-danger" : ""))">
                                    <td>@res.ReservationTime.ToString("h:mm tt")</td>
                                    <td>@res.GuestName</td>
                                    <td>@res.PartySize</td>
                                    <td>@(res.TableId.HasValue ? $"Table {res.TableNumber}" : "-")</td>
                                    <td>@res.Status</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                Actions
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@res.Id">Edit</a></li>
                                                @if (res.Status == ReservationStatus.Confirmed)
                                                {
                                                    <li>
                                                        <form asp-action="ChangeStatus" method="post">
                                                            <input type="hidden" name="id" value="@res.Id" />
                                                            <input type="hidden" name="status" value="@((int)ReservationStatus.Seated)" />
                                                            <button type="submit" class="dropdown-item">Seat Guest</button>
                                                        </form>
                                                    </li>
                                                }
                                                @if (res.Status == ReservationStatus.Seated)
                                                {
                                                    <li>
                                                        <form asp-action="ChangeStatus" method="post">
                                                            <input type="hidden" name="id" value="@res.Id" />
                                                            <input type="hidden" name="status" value="@((int)ReservationStatus.Completed)" />
                                                            <button type="submit" class="dropdown-item">Complete</button>
                                                        </form>
                                                    </li>
                                                }
                                                @if (res.Status == ReservationStatus.Confirmed)
                                                {
                                                    <li>
                                                        <form asp-action="ChangeStatus" method="post">
                                                            <input type="hidden" name="id" value="@res.Id" />
                                                            <input type="hidden" name="status" value="@((int)ReservationStatus.NoShow)" />
                                                            <button type="submit" class="dropdown-item">Mark No-Show</button>
                                                        </form>
                                                    </li>
                                                    <li>
                                                        <form asp-action="ChangeStatus" method="post">
                                                            <input type="hidden" name="id" value="@res.Id" />
                                                            <input type="hidden" name="status" value="@((int)ReservationStatus.Cancelled)" />
                                                            <button type="submit" class="dropdown-item">Cancel</button>
                                                        </form>
                                                    </li>
                                                }
                                                <li><a class="dropdown-item text-danger" asp-action="DeleteConfirm" asp-route-id="@res.Id">Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                            @if (!ViewBag.TodaysReservations.Count)
                            {
                                <tr>
                                    <td colspan="6" class="text-center">No reservations today</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <a asp-action="List" class="btn btn-sm btn-primary">View All</a>
                </div>
            </div>
        </div>

        <!-- Waitlist -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark d-flex justify-content-between">
                    <h5 class="mb-0">Current Waitlist</h5>
                    <span class="badge bg-dark text-light">@ViewBag.Waitlist.Count</span>
                </div>
                <div class="card-body overflow-auto" style="max-height: 400px;">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Added</th>
                                <th>Guest</th>
                                <th>Party</th>
                                <th>Wait Time</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in ViewBag.Waitlist)
                            {
                                <tr class="@(entry.IsWaitTimeExceeded ? "table-danger" : (entry.Status == WaitlistStatus.Notified ? "table-warning" : ""))">
                                    <td>@entry.AddedAt.ToString("h:mm tt")</td>
                                    <td>@entry.GuestName</td>
                                    <td>@entry.PartySize</td>
                                    <td>@entry.ElapsedWaitTime / @entry.QuotedWaitTime min</td>
                                    <td>@entry.Status</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                Actions
                                            </button>
                                            <ul class="dropdown-menu">
                                                @if (entry.Status == WaitlistStatus.Waiting)
                                                {
                                                    <li>
                                                        <form asp-action="UpdateWaitlistStatus" method="post">
                                                            <input type="hidden" name="id" value="@entry.Id" />
                                                            <input type="hidden" name="status" value="@((int)WaitlistStatus.Notified)" />
                                                            <button type="submit" class="dropdown-item">Notify Guest</button>
                                                        </form>
                                                    </li>
                                                }
                                                @if (entry.Status == WaitlistStatus.Notified || entry.Status == WaitlistStatus.Waiting)
                                                {
                                                    <li>
                                                        <form asp-action="UpdateWaitlistStatus" method="post">
                                                            <input type="hidden" name="id" value="@entry.Id" />
                                                            <input type="hidden" name="status" value="@((int)WaitlistStatus.Seated)" />
                                                            <button type="submit" class="dropdown-item">Mark Seated</button>
                                                        </form>
                                                    </li>
                                                }
                                                <li>
                                                    <form asp-action="UpdateWaitlistStatus" method="post">
                                                        <input type="hidden" name="id" value="@entry.Id" />
                                                        <input type="hidden" name="status" value="@((int)WaitlistStatus.Left)" />
                                                        <button type="submit" class="dropdown-item">Mark Left</button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form asp-action="RemoveFromWaitlist" method="post">
                                                        <input type="hidden" name="id" value="@entry.Id" />
                                                        <button type="submit" class="dropdown-item text-danger">Remove</button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                            @if (!ViewBag.Waitlist.Count)
                            {
                                <tr>
                                    <td colspan="6" class="text-center">Waitlist is empty</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <a asp-action="Waitlist" class="btn btn-sm btn-primary">Manage Waitlist</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Layout -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Table Layout</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var table in ViewBag.Tables)
                        {
                            <div class="col-md-2 col-sm-4 col-6 mb-3">
                                <div class="card @GetTableStatusClass(table.Status)">
                                    <div class="card-body text-center py-3">
                                        <h5 class="card-title mb-0">Table @table.TableNumber</h5>
                                        <p class="card-text mb-0">Seats: @table.Capacity</p>
                                        <p class="card-text mb-1">@table.StatusDescription</p>
                                        @if (table.Status == TableStatus.Occupied && table.LastOccupiedAt.HasValue)
                                        {
                                            <small class="text-muted">
                                                Seated at @table.LastOccupiedAt.Value.ToString("h:mm tt")
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tomorrow's Reservations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between">
                    <h5 class="mb-0">Tomorrow's Reservations</h5>
                    <span class="badge bg-light text-dark">@ViewBag.TomorrowsReservations.Count</span>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Guest</th>
                                <th>Party Size</th>
                                <th>Phone</th>
                                <th>Table</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var res in ViewBag.TomorrowsReservations)
                            {
                                <tr>
                                    <td>@res.ReservationTime.ToString("h:mm tt")</td>
                                    <td>@res.GuestName</td>
                                    <td>@res.PartySize</td>
                                    <td>@res.PhoneNumber</td>
                                    <td>@(res.TableId.HasValue ? $"Table {res.TableNumber}" : "-")</td>
                                    <td>@(string.IsNullOrEmpty(res.SpecialRequests) ? "-" : res.SpecialRequests)</td>
                                </tr>
                            }
                            @if (!ViewBag.TomorrowsReservations.Count)
                            {
                                <tr>
                                    <td colspan="6" class="text-center">No reservations for tomorrow</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetTableStatusClass(TableStatus status)
    {
        return status switch
        {
            TableStatus.Available => "bg-success text-white",
            TableStatus.Reserved => "bg-info text-dark",
            TableStatus.Occupied => "bg-danger text-white",
            TableStatus.Dirty => "bg-warning text-dark",
            TableStatus.Maintenance => "bg-secondary text-white",
            _ => "bg-light"
        };
    }
}
