@model OrderViewModel
@{
    ViewData["Title"] = "Order Details";
}
@section Styles {
  <style>
    /* Ensure top nav dropdowns appear above sticky side panels on order details page */
    .navbar { z-index: 2000 !important; }
    #orderDetailsApp .sticky-top { z-index: 100; }
    /* Defensive: allow dropdown menus to overflow visible area */
    .navbar .dropdown-menu { position: absolute; }
  </style>
}
<div class="container-fluid py-3" id="orderDetailsApp" data-order-id="@Model.Id">
  <div class="row g-3">
    <div class="col-lg-8 col-12">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <form id="orderItemAddForm" class="row row-cols-auto g-2 align-items-center flex-grow-1" autocomplete="off">
          @Html.AntiForgeryToken()
          <input type="hidden" id="orderId" value="@Model.Id" />
          <div class="col flex-grow-1" style="min-width:200px;">
            <label for="menuItemInput" class="visually-hidden">Menu Item</label>
            <input list="menuItems" id="menuItemInput" class="form-control form-control-sm" placeholder="Search menu (name)..." required />
            <datalist id="menuItems">
              @foreach (var mi in Model.AvailableMenuItems)
              {
                <option value="@mi.Name" data-id="@mi.Id" data-price="@mi.Price.ToString("F2")">@mi.Name (₹@mi.Price.ToString("F2"))</option>
              }
            </datalist>
          </div>
          <div class="col">
            <label for="menuItemQty" class="visually-hidden">Qty</label>
            <input type="number" id="menuItemQty" class="form-control form-control-sm" min="1" value="1" required />
          </div>
            <div class="col">
            <button type="submit" class="btn btn-sm btn-primary" id="addItemBtn"><i class="fas fa-plus"></i> Add</button>
          </div>
        </form>
        <div class="ms-auto d-flex gap-2">
          <button type="button" id="fireItemsBtn" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#fireItemsModal"><i class="fas fa-fire"></i> Fire To Kitchen</button>
          <a asp-action="Dashboard" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
          <a asp-controller="Payment" asp-action="Index" asp-route-id="@Model.Id" class="btn btn-sm btn-success"><i class="fas fa-credit-card"></i> Payment</a>
        </div>
      </div>
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <div class="small"><strong>Order #:</strong> @Model.OrderNumber <span class="badge bg-secondary ms-2">@Model.StatusDisplay</span></div>
          <button id="saveOrderBtn" class="btn btn-sm btn-primary"><i class="fas fa-save"></i> Save</button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0" id="orderItemsTable">
          <thead class="table-light">
            <tr>
              <th style="width:50px"><input type="checkbox" id="selectAllFire" /></th>
              <th>Item</th>
              <th style="width:90px" class="text-center">Qty</th>
              <th style="width:110px" class="text-end">Unit</th>
              <th style="width:120px" class="text-end">Subtotal</th>
              <th style="width:110px">Status</th>
              <th style="width:70px"></th>
            </tr>
          </thead>
          <tbody id="orderItemsBody">
            @foreach (var it in Model.Items.Where(i=> i.Status != 5))
            {
              <tr data-order-item-id="@it.Id" data-menu-item-id="@it.MenuItemId" class="existing-item-row">
                <td class="text-center"><input type="checkbox" class="fire-select" value="@it.Id" /></td>
                <td>
                  <div class="fw-semibold">@it.MenuItemName</div>
                  <div class="d-flex gap-1 mt-1">
                    <input type="text" class="form-control form-control-sm item-note" value="@it.SpecialInstructions" placeholder="Note" disabled />
                    <button type="button" class="btn btn-sm btn-outline-secondary edit-row" title="Edit"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-success save-row d-none" title="Apply"><i class="fas fa-check"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-warning cancel-row d-none" title="Cancel"><i class="fas fa-undo"></i></button>
                  </div>
                </td>
                <td class="text-center"><input type="number" class="form-control form-control-sm item-qty" value="@it.Quantity" min="1" disabled /></td>
                <td class="text-end">₹@it.UnitPrice.ToString("F2")</td>
                <td class="text-end subtotal-cell">₹@it.Subtotal.ToString("F2")</td>
                <td><span class="badge bg-@(it.Status==0?"primary":it.Status==1?"warning text-dark":it.Status==2?"info":it.Status==3?"success":"secondary")">@it.StatusDisplay</span></td>
                <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-existing"><i class="fas fa-times"></i></button></td>
              </tr>
            }
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td colspan="4" class="text-end fw-semibold">Subtotal:</td>
              <td colspan="3" class="text-end" id="orderSubtotalCell">₹@((Model.Items.Where(i=>i.Status!=5).Sum(i=>i.Subtotal)).ToString("F2"))</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end">GST (@Model.GSTPercentage.ToString("F2")%):</td>
              <td colspan="3" class="text-end" id="orderTaxCell">₹@Model.TaxAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end small text-muted">&nbsp;&nbsp;CGST (@( (Model.GSTPercentage/2).ToString("F2") )%):</td>
              <td colspan="3" class="text-end small text-muted">₹@Model.CGSTAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end small text-muted">&nbsp;&nbsp;SGST (@( (Model.GSTPercentage/2).ToString("F2") )%):</td>
              <td colspan="3" class="text-end small text-muted">₹@Model.SGSTAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end fw-semibold">Total:</td>
              <td colspan="3" class="text-end fw-bold" id="orderTotalCell">₹@((Model.Items.Where(i=>i.Status!=5).Sum(i=>i.Subtotal)+Model.TaxAmount+Model.TipAmount-Model.DiscountAmount).ToString("F2"))</td>
            </tr>
          </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="sticky-top" style="top:1rem;">
        <div class="card mb-3 shadow-sm">
          <div class="card-header py-2"><i class="fas fa-info-circle me-1"></i> Order Summary</div>
          <div class="card-body small">
            <dl class="row mb-0">
              <dt class="col-5">Customer</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerName)?Model.CustomerName: (string.IsNullOrEmpty(Model.GuestName)?"—":Model.GuestName))</dd>
              <dt class="col-5">Phone</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerPhone)?Model.CustomerPhone:"—")</dd>
              <dt class="col-5">Table</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.TableName)?Model.TableName:"—")</dd>
              <dt class="col-5">Server</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.ServerName)?Model.ServerName:"—")</dd>
              <dt class="col-5">Type</dt><dd class="col-7">@Model.OrderTypeDisplay</dd>
              <dt class="col-5">Created</dt><dd class="col-7">@Model.CreatedAt.ToString("g")</dd>
            </dl>
          </div>
        </div>
        <div class="card mb-3 shadow-sm">
          <div class="card-header py-2"><i class="fas fa-sticky-note me-1"></i> Order Note</div>
          <div class="card-body small">
            @if(!string.IsNullOrWhiteSpace(Model.SpecialInstructions)){
              <div class="text-muted">@Model.SpecialInstructions</div>
            } else { <div class="text-muted fst-italic">No note provided.</div> }
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-header py-2"><i class="fas fa-receipt me-1"></i> Totals</div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0">
              <tbody class="small">
                <tr><td class="text-muted">Subtotal</td><td class="text-end" id="orderSubtotalCell">₹@Model.Subtotal.ToString("F2")</td></tr>
                <tr><td class="text-muted">GST (@Model.GSTPercentage.ToString("F2")%)</td><td class="text-end" id="orderTaxCell">₹@Model.TaxAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted small ps-3">CGST (@( (Model.GSTPercentage/2).ToString("F2") )%)</td><td class="text-end small">₹@Model.CGSTAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted small ps-3">SGST (@( (Model.GSTPercentage/2).ToString("F2") )%)</td><td class="text-end small">₹@Model.SGSTAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted">Tip</td><td class="text-end">₹@Model.TipAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted">Discount</td><td class="text-end">₹@Model.DiscountAmount.ToString("F2")</td></tr>
                <tr class="table-light"><th>Total</th><th class="text-end" id="orderTotalCell">₹@Model.TotalAmount.ToString("F2")</th></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  @if (Model.Items.Any(i=>i.Status==0))
  {
    <div class="modal fade" id="fireItemsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="fireItemsForm" asp-action="FireItems" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="OrderId" value="@Model.Id" />
            <div class="modal-header"><h5 class="modal-title">Send Items To Kitchen</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <div class="mb-2 d-flex justify-content-between align-items-center">
                <span class="small text-muted">Select which un-fired items to send.</span>
                <div class="form-check form-check-sm">
                  <input type="checkbox" class="form-check-input" id="fireSelectAll" />
                  <label for="fireSelectAll" class="form-check-label small">All</label>
                </div>
              </div>
              <div class="list-group small" style="max-height:260px;overflow:auto;">
                @foreach (var ni in Model.Items.Where(i=>i.Status==0))
                {
                  <label class="list-group-item d-flex align-items-center gap-2 py-1">
                    <input type="checkbox" class="form-check-input fire-item-checkbox" value="@ni.Id" name="SelectedItems" />
                    <span class="flex-grow-1 d-flex justify-content-between align-items-center">
                      <span>@ni.MenuItemName</span>
                      <span class="badge bg-light text-dark border" style="font-weight:500;">x @ni.Quantity</span>
                    </span>
                  </label>
                }
                @if(!Model.Items.Any(i=>i.Status==0)){
                  <div class="text-muted fst-italic px-2 py-1">No pending items to fire.</div>
                }
              </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="fas fa-fire"></i> Send To Kitchen</button></div>
          </form>
        </div>
      </div>
    </div>
  }
</div>

@section Scripts {
  <script src="~/js/order-modern.js"></script>
}
