@model QRCodeManagementViewModel
@{
    ViewData["Title"] = "QR Code Management";
}

<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-qrcode me-2"></i>@ViewData["Title"]</h1>
        <div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateQRModal">
                <i class="fas fa-plus"></i> Generate QR Code
            </button>
            <button class="btn btn-info ms-2" onclick="generateBulkQRCodes()">
                <i class="fas fa-download"></i> Bulk Generate for All Tables
            </button>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Restaurant Information Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Restaurant Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> @Model.RestaurantInfo.Name</p>
                    <p><strong>Contact:</strong> @Model.RestaurantInfo.ContactNumber</p>
                    <p><strong>Email:</strong> @Model.RestaurantInfo.Email</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Address:</strong> @Model.RestaurantInfo.Address</p>
                    <p><strong>Website:</strong> @Model.RestaurantInfo.Website</p>
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <i class="fas fa-lightbulb me-2"></i>
                This information will be displayed to customers when they scan your QR codes.
            </div>
        </div>
    </div>

    <!-- QR Code Generator Section -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Quick QR Code Generator</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>General Restaurant Menu</h6>
                            <p class="text-muted">Shows complete menu without table information</p>
                            <button class="btn btn-outline-primary w-100" onclick="generateQRCode('GeneralMenu')">
                                <i class="fas fa-qrcode me-2"></i>Generate General Menu QR
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Table-Specific Menu</h6>
                            <p class="text-muted">Select a table to generate specific QR code</p>
                            <div class="input-group mb-2">
                                <select id="tableSelect" class="form-select">
                                    <option value="">Select Table...</option>
                                    @foreach (var table in Model.Tables)
                                    {
                                        <option value="@table.Id">@table.TableName</option>
                                    }
                                </select>
                                <button class="btn btn-outline-success" onclick="generateTableQRCode()">
                                    <i class="fas fa-qrcode"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>QR Code Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">@Model.Tables.Count</h4>
                            <small class="text-muted">Total Tables</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">âˆž</h4>
                            <small class="text-muted">QR Codes Available</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">QR codes are generated on-demand</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated QR Code Display Area -->
    <div id="qrCodeDisplay" class="card mt-4" style="display: none;">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>Generated QR Code</h5>
        </div>
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-6">
                    <div id="qrCodeImageContainer"></div>
                    <div class="mt-3">
                        <button id="downloadQRBtn" class="btn btn-success me-2">
                            <i class="fas fa-download"></i> Download PNG
                        </button>
                        <button class="btn btn-outline-secondary" onclick="printQRCode()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div id="qrCodeInfo" class="text-start">
                        <!-- QR Code info will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables List -->
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Tables (@Model.Tables.Count)</h5>
        </div>
        <div class="card-body">
            @if (Model.Tables.Any())
            {
                <div class="row">
                    @foreach (var table in Model.Tables)
                    {
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="card-title">@table.TableName</h6>
                                    <p class="card-text small text-muted">@table.Capacity persons</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="generateQRCode('TableSpecific', @table.Id)">
                                        <i class="fas fa-qrcode"></i> Generate QR
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No tables found. Please add tables first to generate table-specific QR codes.
                </div>
            }
        </div>
    </div>
</div>

<!-- Generate QR Modal -->
<div class="modal fade" id="generateQRModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Generate QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="qrGenerateForm">
                    <div class="mb-3">
                        <label for="qrCodeType" class="form-label">QR Code Type</label>
                        <select class="form-select" id="qrCodeType" name="codeType">
                            <option value="GeneralMenu">General Menu</option>
                            <option value="TableSpecific">Table Specific</option>
                        </select>
                    </div>
                    <div class="mb-3" id="tableSelectDiv" style="display: none;">
                        <label for="modalTableSelect" class="form-label">Select Table</label>
                        <select class="form-select" id="modalTableSelect" name="tableId">
                            <option value="">Choose table...</option>
                            @foreach (var table in Model.Tables)
                            {
                                <option value="@table.Id">@table.TableName</option>
                            }
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateFromModal()">
                    <i class="fas fa-magic"></i> Generate QR Code
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Show/hide table select based on QR code type
        document.getElementById('qrCodeType').addEventListener('change', function() {
            const tableDiv = document.getElementById('tableSelectDiv');
            if (this.value === 'TableSpecific') {
                tableDiv.style.display = 'block';
            } else {
                tableDiv.style.display = 'none';
            }
        });

        function generateQRCode(codeType, tableId = null) {
            const formData = new FormData();
            formData.append('codeType', codeType);
            if (tableId) {
                formData.append('tableId', tableId);
            }

            fetch('@Url.Action("GenerateQRCode")', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayQRCode(data.data);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating the QR code.');
            });
        }

        function generateTableQRCode() {
            const tableSelect = document.getElementById('tableSelect');
            const tableId = tableSelect.value;
            
            if (!tableId) {
                alert('Please select a table first.');
                return;
            }
            
            generateQRCode('TableSpecific', tableId);
        }

        function generateFromModal() {
            const codeType = document.getElementById('qrCodeType').value;
            const tableId = document.getElementById('modalTableSelect').value;
            
            if (codeType === 'TableSpecific' && !tableId) {
                alert('Please select a table for table-specific QR codes.');
                return;
            }
            
            generateQRCode(codeType, tableId || null);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('generateQRModal'));
            modal.hide();
        }

        function displayQRCode(qrData) {
            const displayDiv = document.getElementById('qrCodeDisplay');
            const imageContainer = document.getElementById('qrCodeImageContainer');
            const infoContainer = document.getElementById('qrCodeInfo');
            const downloadBtn = document.getElementById('downloadQRBtn');
            
            // Display QR code image
            imageContainer.innerHTML = `<img src="data:image/png;base64,${qrData.qrCodeBase64}" class="img-fluid" style="max-width: 300px;" alt="QR Code">`;
            
            // Display QR code information
            infoContainer.innerHTML = `
                <h6>QR Code Details</h6>
                <p><strong>Type:</strong> ${qrData.codeType}</p>
                <p><strong>Table:</strong> ${qrData.tableName || 'General Menu'}</p>
                <p><strong>Restaurant:</strong> ${qrData.restaurantName}</p>
                <p><strong>Contact:</strong> ${qrData.contactNumber}</p>
                <p><strong>URL:</strong> <a href="${qrData.qrCodeUrl}" target="_blank">${qrData.qrCodeUrl}</a></p>
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle me-1"></i>
                    Customers can scan this QR code to view your menu with restaurant information.
                    </small>
                </div>
            `;
            
            // Set download button
            downloadBtn.onclick = function() {
                const downloadUrl = '@Url.Action("DownloadQRCode")' + 
                    `?codeType=${qrData.codeType}` + 
                    (qrData.tableId ? `&tableId=${qrData.tableId}` : '');
                window.open(downloadUrl, '_blank');
            };
            
            displayDiv.style.display = 'block';
            displayDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function generateBulkQRCodes() {
            if (confirm('This will generate QR codes for all tables. Continue?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("GenerateBulkTableQRCodes")';
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    form.appendChild(token.cloneNode(true));
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function printQRCode() {
            const qrImage = document.querySelector('#qrCodeImageContainer img');
            if (qrImage) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>QR Code - Print</title>
                            <style>
                                body { text-align: center; padding: 20px; }
                                img { max-width: 400px; }
                            </style>
                        </head>
                        <body>
                            <h3>Restaurant Menu QR Code</h3>
                            <img src="${qrImage.src}" alt="QR Code">
                            <p>Scan to view menu</p>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }
    </script>
}