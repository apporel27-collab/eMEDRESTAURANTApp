@model RestaurantManagementSystem.Models.CustomerReportViewModel

@{
    ViewData["Title"] = "Customer Reports";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users me-2"></i>Customer Reports</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                        <li class="breadcrumb-item active">Reports</li>
                        <li class="breadcrumb-item active">Customers</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <form method="post" asp-action="Customers" class="row g-3 align-items-end mb-4">
        <div class="col-auto">
            <label asp-for="Filter.From" class="form-label">From</label>
            <input asp-for="Filter.From" class="form-control" />
        </div>
        <div class="col-auto">
            <label asp-for="Filter.To" class="form-label">To</label>
            <input asp-for="Filter.To" class="form-control" />
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Run Report</button>
        </div>
    </form>

    <div class="row">
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Customers</h5>
                    <p class="display-6">@Model.Summary.TotalCustomers</p>
                    <small class="text-muted">New: @Model.Summary.NewCustomers | Returning: @Model.Summary.ReturningCustomers</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Avg Visits</h5>
                    <p class="display-6">@Model.Summary.AverageVisitsPerCustomer</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Revenue</h5>
                    <p class="display-6">@Model.Summary.TotalRevenue.ToString("C")</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Top Customers</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Name</th><th>Phone</th><th>Visits</th><th>Revenue</th><th>LTV</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Model.TopCustomers)
                            {
                                <tr>
                                    <td>@c.Name</td>
                                    <td>@c.Phone</td>
                                    <td>@c.Visits</td>
                                    <td>@c.Revenue.ToString("C")</td>
                                    <td>@c.LTV.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Visit Frequency</div>
                <div class="card-body">
                    <canvas id="visitFrequencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Loyalty Buckets</div>
                <div class="card-body">
                    <ul>
                        @foreach (var b in Model.LoyaltyStats)
                        {
                            <li>@b.Bucket: @b.CustomerCount</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Demographics</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead><tr><th>Category</th><th>Count</th></tr></thead>
                        <tbody>
                            @foreach (var d in Model.Demographics)
                            {
                                <tr><td>@d.Category</td><td>@d.Count</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function(){
            var visits = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.VisitFrequencies.Select(x=> new { x.Period, x.Visits, x.Revenue })));
            var ctx = document.getElementById('visitFrequencyChart').getContext('2d');
            var labels = visits.map(v=>v.Period);
            var data = visits.map(v=>v.Visits);
            new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Visits', data: data, borderColor: '#007bff', fill:false }] }, options: { responsive:true } });
        })();
    </script>
}